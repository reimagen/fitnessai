---
phase: 01-firestore-security-hardening
plan: 03
type: execute
wave: 1
depends_on: ["01-01"]
files_modified:
  - firestore.rules
autonomous: true
must_haves:
  truths:
    - "Exercises collection requires authentication (no anonymous reads)"
    - "Custom user exercises scoped to /users/{uid}/exercises are user-isolated"
    - "Regular users cannot write to global exercises collection"
    - "Service account can write to exercises (Admin SDK bypass)"
  artifacts:
    - path: "firestore.rules"
      provides: "Stage 2 rules for exercises and custom exercises"
      rule_scope:
        - "exercises/{id}"
        - "users/{uid}/exercises/{name}"
  key_links:
    - from: "firestore.rules"
      to: "exercises collection"
      via: "require auth check; allow user read only"
      pattern: "allow read: if request.auth != null; allow write: if false"
    - from: "firestore.rules"
      to: "/users/{uid}/exercises"
      via: "user-scoped custom exercises with uid isolation"
      pattern: "allow read, write: if isOwner(uid)"
---

# Plan 1.3: Write Stage 2 Exercises & Custom Exercises Rules

**Wave:** 1
**Depends on:** Plan 1.1 (Stage 1 rules established)
**Autonomous:** Yes

## Objective

Write rules for Stage 2 collections (exercises, custom user exercises) to enforce that the global exercises collection requires authentication and prevents user writes, while custom exercises under `/users/{uid}/exercises` are user-scoped and isolated.

**Purpose:** Complete the security rules by adding the shared exercises collection (with authentication requirement) and custom user exercises. Ready for combined Stage 1+2 validation.

**Output:** Updated firestore.rules file with both Stage 1 and Stage 2 rules complete.

## Execution Context

@/Users/lisagu/Projects/fitnessai-1/firestore.rules
@/Users/lisagu/Projects/fitnessai-1/.planning/phases/01-firestore-security-hardening/01-CONTEXT.md

## Context

**Stage 2 scope:**
- `exercises/{id}` — Global exercise library (admin-maintained, user read-only)
- `users/{uid}/exercises/{name}` — Custom exercises created by individual users (user can read/write own)

**Key requirement for exercises collection:**
- Current rules: `allow read: if true` (INSECURE - allows anonymous reads)
- Must change to: `allow read: if request.auth != null` (require authentication per SEC-02)
- Writes remain: `allow write: if false` (no user writes, only admin via service account)

**Key requirement for custom exercises:**
- Users can create their own custom exercises under `/users/{uid}/exercises`
- Each user can only read/write their own custom exercises
- Stored at path `/users/{uid}/exercises/{exerciseName}`

**Admin access:**
- Service account (Firebase Admin SDK) can write to exercises collection (bypasses rules)
- No app-level admin interface; admin edits via Firebase Console or backend scripts

## Tasks

<task id="1.3.1" title="Update exercises collection rules to require authentication">
  <description>
  Update the rules for exercises collection:

  Current (INSECURE):
  ```
  match /exercises/{exerciseId} {
    allow read: if true;
    allow write: if false;
  }
  ```

  New (SECURE):
  ```
  match /exercises/{exerciseId} {
    allow read: if request.auth != null;
    allow write: if false;
  }
  ```

  Also update exerciseAliases and config collections the same way:
  ```
  match /exerciseAliases/{aliasId} {
    allow read: if request.auth != null;
    allow write: if false;
  }

  match /config/{configId} {
    allow read: if request.auth != null;
    allow write: if false;
  }
  ```

  Why: Prevents anonymous users from reading exercises (satisfies SEC-02: no anonymous access). Service account still can write via Admin SDK (which bypasses Firestore rules).

  File to modify: firestore.rules (already exists with Stage 1 rules from Plan 1.1)
  </description>
  <acceptance_criteria>
    - [ ] exercises collection read rule changed from `if true` to `if request.auth != null`
    - [ ] exerciseAliases collection read rule changed to require auth
    - [ ] config collection read rule changed to require auth
    - [ ] Write rules remain `allow write: if false` (no user writes allowed)
    - [ ] Rules syntax is valid
  </acceptance_criteria>
</task>

<task id="1.3.2" title="Add custom user exercises rules under /users/{uid}/exercises">
  <description>
  Add a new subcollection rule under users/{uid} for custom exercises:

  ```
  match /users/{userId} {
    allow read, write: if isOwner(userId);

    // Add this new block:
    match /exercises/{exerciseName} {
      allow read, write: if isOwner(userId);
    }

    // Keep existing subcollections (profiles, workouts, personalRecords)
    match /profiles/{document=**} {
      allow read, write: if isOwner(userId);
    }
    // ... etc
  }
  ```

  Why: Users can create custom exercises (e.g., "juggling") under their own path. Each user's custom exercises are isolated and can only be accessed by that user.

  Placement: Add after the users/{userId} main rule, before wildcard catch-all.

  File to modify: firestore.rules (add to the users/{userId} section)
  </description>
  <acceptance_criteria>
    - [ ] /users/{userId}/exercises/{exerciseName} rule added
    - [ ] Rule uses isOwner(userId) to enforce user isolation
    - [ ] Allows read and write (users can create/update/delete custom exercises)
    - [ ] Placed inside the users/{userId} match block (inherits uid variable)
    - [ ] Rules syntax is valid
  </acceptance_criteria>
</task>

<task id="1.3.3" title="Verify Stage 1 + Stage 2 rules are complete and consistent">
  <description>
  Review the complete firestore.rules file to ensure:

  1. Stage 1 rules (users, profiles, workouts, PRs) are present and unchanged from Plan 1.1
  2. isOwner() helper function is at the top
  3. Stage 2 rules (exercises, exerciseAliases, config, custom exercises) are added
  4. All user-isolated paths use isOwner(userId) check
  5. All shared collections (exercises, exerciseAliases, config) require `request.auth != null`
  6. No overly permissive rules (e.g., `allow read: if true` without auth check)
  7. Wildcard catch-all rule still in place: `match /{document=**} { allow read, write: if false; }`

  Expected structure:
  ```
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isOwner(userId) { ... }

      // Stage 1: User-isolated collections
      match /users/{userId} {
        allow read, write: if isOwner(userId);
        match /profiles/{document=**} { ... }
        match /workouts/{document=**} { ... }
        match /personalRecords/{document=**} { ... }
        match /exercises/{exerciseName} { ... }  // Stage 2: custom exercises
      }

      // Stage 2: Shared collections (require auth)
      match /exercises/{exerciseId} { ... }
      match /exerciseAliases/{aliasId} { ... }
      match /config/{configId} { ... }

      // Catch-all deny
      match /{document=**} { allow read, write: if false; }
    }
  }
  ```

  Document: Note any missing paths or inconsistencies. If found, fix before proceeding to testing.
  </description>
  <acceptance_criteria>
    - [ ] Stage 1 rules verified present (users, profiles, workouts, PRs)
    - [ ] Stage 2 rules verified added (exercises, custom exercises)
    - [ ] isOwner() helper function at top of rules
    - [ ] All user-isolated paths use isOwner check
    - [ ] All shared collections require request.auth != null
    - [ ] No overly permissive rules
    - [ ] Wildcard catch-all in place
    - [ ] File is syntactically valid (no obvious errors)
  </acceptance_criteria>
</task>

## Verification

1. Syntax check: firestore.rules file has no obvious syntax errors
2. Auth requirement check: Confirm all user-facing collections require `request.auth != null`
3. Rule completeness: Confirm all collections mentioned in 01-CONTEXT.md have rules
4. Consistency: Confirm all user-isolated paths use the same isOwner() pattern

## Success Criteria

- [ ] exercises, exerciseAliases, config collections now require authentication (no anonymous reads)
- [ ] Custom user exercises at /users/{uid}/exercises added with user isolation
- [ ] All Stage 1 rules still present and unchanged
- [ ] firestore.rules is syntactically valid and complete
- [ ] Ready for combined Stage 1+2 testing in emulator (Plan 1.4)

## Notes

**Locked decisions:**
- Custom exercises are user-scoped (no sharing between users)
- No app-level admin interface; admin edits via Firebase Console or service account scripts
- Service account (Admin SDK) bypasses rules; no need for custom admin role claims

**Next steps:** Plan 1.4 will test combined Stage 1+2 rules in emulator to ensure no conflicts. Plan 1.5 will deploy to staging with full validation.

**Context:** 01-CONTEXT.md specifies custom exercises strategy, admin access model, and shared vs. isolated collections.
