---
phase: 01-firestore-security-hardening
plan: 04
type: execute
wave: 2
depends_on: ["01-02", "01-03"]
files_modified:
  - firestore.rules
autonomous: true
must_haves:
  truths:
    - "Stage 2 rules tested in emulator without failures"
    - "Authenticated user cannot read exercises without auth"
    - "Authenticated user can create and manage custom exercises"
    - "All three critical scenarios still pass with combined Stage 1+2 rules"
  artifacts:
    - path: "firestore.rules"
      provides: "Complete Stage 1+2 rules, tested in emulator"
      min_lines: 80
  key_links:
    - from: "firestore.rules"
      to: "Firestore Emulator"
      via: "deployed and tested with Stage 1+2 rules"
      pattern: "Three critical scenarios + exercises auth requirements validated"
---

# Plan 1.4: Test Stage 1+2 Rules Combined in Emulator

**Wave:** 2
**Depends on:** Plan 1.2 (Stage 1 validated) + Plan 1.3 (Stage 2 rules written)
**Autonomous:** Yes

## Objective

Deploy combined Stage 1+2 rules to Firestore Emulator and validate that both stages work together without conflicts. Verify the three critical security scenarios still pass, plus new Stage 2 scenarios (exercises require auth, custom exercises are user-scoped).

**Purpose:** Ensure Stage 2 rules don't break Stage 1 functionality before deploying both stages to staging.

**Output:** Combined Stage 1+2 rules tested and validated in emulator. Ready for staging deployment.

## Execution Context

@/Users/lisagu/Projects/fitnessai-1/firestore.rules
@/Users/lisagu/Projects/fitnessai-1/.planning/phases/01-firestore-security-hardening/01-CONTEXT.md

## Context

**Testing approach:** Re-validate the three Stage 1 critical scenarios (user isolation, anonymous denial, subcollection inheritance) plus two new Stage 2 scenarios (exercises require auth, custom exercises are user-isolated).

**Emulator setup:** Same as Plan 1.2. Start fresh emulator with updated rules.

**Success criteria:** All five scenarios pass without errors.

## Tasks

<task id="1.4.1" title="Restart Firestore Emulator with combined Stage 1+2 rules">
  <description>
  1. Stop current emulator (if running): Ctrl+C or `firebase emulator:stop`
  2. Start fresh emulator with updated rules: `firebase emulator:start --only firestore --clear-on-exit`
  3. Emulator loads firestore.rules (with both Stage 1 and Stage 2 rules)
  4. Verify console output shows no rule syntax errors
  5. Emulator ready for testing on localhost:8080

  Expected output:
  ```
  Firestore Emulator started on localhost:8080
  Rules loaded from firestore.rules
  ```

  If syntax errors: Fix rules in firestore.rules and restart emulator.
  </description>
  <acceptance_criteria>
    - [ ] Emulator stopped (if was running)
    - [ ] New emulator started with `firebase emulator:start --only firestore --clear-on-exit`
    - [ ] Console shows "Firestore Emulator started"
    - [ ] No rule syntax errors reported
    - [ ] Emulator ready for test requests on localhost:8080
  </acceptance_criteria>
</task>

<task id="1.4.2" title="Re-validate Stage 1 critical scenarios (user isolation, anonymous denial, subcollection)">
  <description>
  Re-run the three critical scenarios from Plan 1.2 to ensure Stage 2 rules didn't break Stage 1:

  **Scenario 1: User Isolation (Alice cannot read Bob's workouts)**
  - Test with Alice's token to read /users/alice-uid/workouts/w1: Should succeed (200)
  - Test with Bob's token to read /users/alice-uid/workouts/w1: Should fail (403 Forbidden)

  **Scenario 2: Anonymous Denied (No token = denied)**
  - Test without Authorization header to read /users/alice-uid/workouts/w1: Should fail (401/403)

  **Scenario 3: Subcollection Inheritance (User isolation applies to nested paths)**
  - Test with Alice's token to read /users/alice-uid/workouts/w1/sets/s1: Should succeed (200)
  - Test with Bob's token to read /users/alice-uid/workouts/w1/sets/s1: Should fail (403 Forbidden)

  Use same test approach as Plan 1.2 (curl or Node.js script with Firebase SDK).

  Document each result: scenario, request, expected result, actual result.
  </description>
  <acceptance_criteria>
    - [ ] Scenario 1 tested: User isolation still works (Alice can read own, Bob cannot)
    - [ ] Scenario 2 tested: Anonymous denial still works
    - [ ] Scenario 3 tested: Subcollection inheritance still works
    - [ ] All three scenarios pass (same results as Plan 1.2)
    - [ ] No new failures introduced by Stage 2 rules
  </acceptance_criteria>
</task>

<task id="1.4.3" title="Validate Stage 2 scenarios (exercises auth requirement, custom exercises isolation)">
  <description>
  Test two new Stage 2 scenarios:

  **Scenario 4: Exercises Require Authentication (No anonymous access to exercises)**
  - Test without Authorization header to read /exercises/{id}: Should fail (401/403)
  - Test with Alice's token to read /exercises/{id}: Should succeed (200)
  - Confirms SEC-02 requirement: All collections require authentication

  **Scenario 5: Custom Exercises User Isolation (Alice cannot read Bob's custom exercises)**
  - Create test data: Alice's custom exercise at /users/alice-uid/exercises/juggling
  - Test with Alice's token to read her custom exercise: Should succeed (200)
  - Test with Bob's token to read Alice's custom exercise: Should fail (403 Forbidden)
  - Test with Alice's token to create a custom exercise: Should succeed (200)
  - Confirms custom exercises are user-scoped and isolated

  Use curl or Firebase SDK as in Plan 1.2.

  Document each result: scenario, request, expected result, actual result.
  </description>
  <acceptance_criteria>
    - [ ] Scenario 4 tested: Exercises require authentication (anonymous denied)
    - [ ] Scenario 5 tested: Custom exercises are user-isolated (Alice can read/write own, Bob cannot)
    - [ ] Both scenarios pass
    - [ ] Exercises read access works for authenticated users (not completely blocked)
  </acceptance_criteria>
</task>

<task id="1.4.4" title="Fix any issues and document Stage 1+2 validation complete">
  <description>
  If any test failed:
  1. Identify which scenario failed and why
  2. Review firestore.rules logic for the failing path
  3. Fix the rule
  4. Restart emulator: `firebase emulator:stop` then `firebase emulator:start --only firestore`
  5. Re-run the failing test to verify fix

  If all tests passed:
  1. Summarize test results: 5 scenarios tested, all passed
  2. Note: Stage 1+2 rules validated in emulator, ready for staging deployment
  3. Next steps: Plan 1.5 (deploy to staging), Plan 1.6 (production deployment), Plan 1.7 (TEST-CHECKLIST.md)

  Do NOT deploy to staging or production yet. That's Plan 1.5.
  </description>
  <acceptance_criteria>
    - [ ] If failures: issues identified, rules fixed, emulator restarted, tests re-run
    - [ ] If all pass: summary documented
    - [ ] All five scenarios (Stage 1: 3, Stage 2: 2) show PASS status
    - [ ] No unresolved test failures
    - [ ] Ready for staging deployment
  </acceptance_criteria>
</task>

## Verification

1. Emulator running: `firebase emulator:start --only firestore` shows no errors
2. Stage 1 scenarios still passing: User isolation, anonymous denial, subcollection inheritance
3. Stage 2 scenarios passing: Exercises auth requirement, custom exercises isolation
4. All five scenarios validated

## Success Criteria

- [ ] Combined Stage 1+2 rules deployed to emulator without syntax errors
- [ ] All three Stage 1 critical scenarios still pass
- [ ] Two Stage 2 scenarios validated: exercises require auth, custom exercises are user-isolated
- [ ] All five scenarios show expected behavior
- [ ] Stage 1+2 rules approved and ready for staging deployment

## Notes

**Wave 2 dependency:** This plan depends on both Plan 1.2 (Stage 1 validation) and Plan 1.3 (Stage 2 rules written). Both must complete before this plan executes.

**Emulator isolation:** Each emulator run is independent. Resetting emulator between test cycles is safe and recommended.

**No production touching:** Emulator testing is local only. No real data affected.

**Next steps:** After Stage 1+2 validation, proceed to Plan 1.5 (staging deployment) and Plan 1.6 (production deployment). Plan 1.7 will create TEST-CHECKLIST.md with manual validation steps for audit/compliance.

**Locked decisions:** Two-stage deployment ensures user isolation is solid before adding shared collection complexity. Testing at each stage validates incrementally.
