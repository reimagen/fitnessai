---
phase: 01-firestore-security-hardening
plan: 02
type: execute
wave: 1
depends_on: ["01-01"]
files_modified:
  - firestore.rules
autonomous: true
must_haves:
  truths:
    - "Stage 1 user isolation rules tested in emulator without failures"
    - "Authenticated user can create/read/update/delete own workouts in emulator"
    - "Authenticated user cannot read other user's workouts in emulator"
    - "Unauthenticated request to workouts returns permission denied in emulator"
  artifacts:
    - path: "firestore.rules"
      provides: "Validated Stage 1 rules (users, profiles, workouts, PRs) tested in emulator"
      min_lines: 40
  key_links:
    - from: "firestore.rules"
      to: "Firestore Emulator"
      via: "firebase emulator:start, test requests with curl"
      pattern: "Test with curl -H 'Authorization: Bearer {token}' to verify auth checks"
---

# Plan 1.2: Test Stage 1 Rules in Firestore Emulator

**Wave:** 1
**Depends on:** Plan 1.1 (Stage 1 rules written)
**Autonomous:** Yes

## Objective

Deploy Stage 1 rules to Firestore Emulator and validate the three critical security scenarios: user isolation, anonymous denial, and subcollection inheritance. Ensure no bugs in rule logic before proceeding to Stage 2.

**Purpose:** Verify that Stage 1 rules work correctly in a safe local environment before touching staging/production databases.

**Output:** Stage 1 rules tested and validated in emulator. Ready for Stage 2 rule writing or staging deployment.

## Execution Context

@/Users/lisagu/Projects/fitnessai-1/firestore.rules
@/Users/lisagu/Projects/fitnessai-1/.planning/phases/01-firestore-security-hardening/01-CONTEXT.md

## Context

**Emulator setup:** Firebase emulator runs locally on localhost:8080 (Firestore). Rules can be tested with curl/SDK without affecting real data.

**Test approach:** Three critical security scenarios from 01-CONTEXT.md:
1. User isolation: Authenticated user cannot read other user's data
2. Anonymous denied: Unauthenticated request denied
3. Subcollection inheritance: User isolation applies to nested collections

**Tools available:**
- firebase emulator:start (starts Firestore Emulator locally)
- curl (for manual HTTP testing with auth headers)
- Node.js with Firebase Admin SDK (for programmatic testing)

**Success criteria:** All three scenarios pass without permission errors.

## Tasks

<task id="1.2.1" title="Start Firestore Emulator and deploy Stage 1 rules">
  <description>
  1. Run `firebase emulator:start --only firestore` from project root to start Firestore Emulator
  2. Emulator will load firestore.rules from the file and apply them
  3. Verify emulator is running on localhost:8080/firestore (check console output)
  4. Keep emulator running for testing in next task

  Command: `firebase emulator:start --only firestore`

  Expected output:
  ```
  Firestore Emulator started on localhost:8080
  Rules loaded from firestore.rules
  ```

  If rules have syntax errors, emulator will report them. Fix and restart.

  Do NOT proceed to task 1.2.2 until emulator is running successfully with rules loaded.
  </description>
  <acceptance_criteria>
    - [ ] Emulator started: `firebase emulator:start --only firestore`
    - [ ] Console output confirms "Firestore Emulator started on localhost:8080"
    - [ ] No rule syntax errors reported
    - [ ] Emulator ready for test requests
  </acceptance_criteria>
</task>

<task id="1.2.2" title="Validate three critical security scenarios in emulator">
  <description>
  Test three critical security scenarios using curl requests to emulator:

  **Scenario 1: User Isolation (Alice cannot read Bob's workouts)**
  - Create test data: Alice's workout at /users/alice-uid/workouts/w1
  - Test with Alice's token: Should succeed (200)
  - Test with Bob's token: Should fail (403 Forbidden)
  - Command pattern:
    ```
    curl -X GET http://localhost:8080/v1/projects/{project-id}/databases/{database-id}/documents/users/alice-uid/workouts/w1 \
      -H "Authorization: Bearer {alice-token}"  # Should succeed
    curl -X GET http://localhost:8080/v1/projects/{project-id}/databases/{database-id}/documents/users/alice-uid/workouts/w1 \
      -H "Authorization: Bearer {bob-token}"    # Should fail with 403
    ```

  **Scenario 2: Anonymous Denied (No token = denied)**
  - Test without Authorization header: Should fail (401 or 403)
  - Command pattern:
    ```
    curl -X GET http://localhost:8080/v1/projects/{project-id}/databases/{database-id}/documents/users/alice-uid/workouts/w1
    # Should fail with 401/403, not return data
    ```

  **Scenario 3: Subcollection Inheritance (User isolation applies to nested paths)**
  - Create test data: Alice's workout set at /users/alice-uid/workouts/w1/sets/s1
  - Test with Alice's token: Should succeed (200)
  - Test with Bob's token: Should fail (403 Forbidden)
  - Verify that uid check in parent path prevents Bob's access to Alice's nested data

  **Test tools:**
  - Use curl with -v flag to see response codes
  - For authentication tokens: Use Firebase emulator auth tokens (available via Firebase Admin SDK or emulator auth endpoint)
  - Document each test result: scenario name, request, expected result, actual result

  **Shortcut for quick validation:**
  If curl testing is tedious, use Node.js script with Firebase SDK:
  - Initialize SDK pointing to localhost:8080
  - Use signInWithEmailAndPassword to get Alice and Bob tokens
  - Call db.collection('users').doc('alice-uid').collection('workouts').get() with each token
  - Log results (success/failure)
  </description>
  <acceptance_criteria>
    - [ ] Scenario 1 tested: Alice can read own workout, Bob cannot (403 Forbidden)
    - [ ] Scenario 2 tested: Unauthenticated request denied (401/403)
    - [ ] Scenario 3 tested: Subcollection isolation works (uid check prevents cross-user access)
    - [ ] All three scenarios produce expected results
    - [ ] Test results documented (what was tested, expected vs actual)
    - [ ] No unexpected permission errors
  </acceptance_criteria>
</task>

<task id="1.2.3" title="Fix any rule issues found during testing and re-validate">
  <description>
  If any test failed:
  1. Review the failure: which scenario failed, what was the error
  2. Examine firestore.rules logic: is the uid check correct, is auth check present
  3. Fix the rule logic in firestore.rules
  4. Restart emulator: `firebase emulator:stop` then `firebase emulator:start --only firestore`
  5. Re-run the failing test to verify fix

  If all tests passed, skip this task and proceed to task 1.2.4.

  Common issues:
  - Missing `request.auth != null` check: allows anonymous access
  - Incorrect uid variable in path: e.g., using `userId` instead of uid from path
  - Subcollection rules not inheriting parent uid: need to match /users/{userId}/... pattern
  </description>
  <acceptance_criteria>
    - [ ] If no failures: mark task skipped
    - [ ] If failures: issues identified and rule logic fixed
    - [ ] Emulator restarted with corrected rules
    - [ ] Re-validation shows all tests passing
    - [ ] No unresolved test failures
  </acceptance_criteria>
</task>

<task id="1.2.4" title="Document emulator test results and approve for staging">
  <description>
  Create a simple test results summary:

  1. Write test results to console/log:
     - Scenario 1 (User Isolation): PASS or FAIL + details
     - Scenario 2 (Anonymous Denied): PASS or FAIL + details
     - Scenario 3 (Subcollection Inheritance): PASS or FAIL + details

  2. Confirm all three scenarios passed

  3. Note any assumptions (e.g., "Used test UIDs alice-uid, bob-uid" or "Tested only read access, not write")

  4. Approval signal: "Stage 1 rules validated in emulator. Ready for deployment."

  This documentation will be referenced in Plan 1.4 (staging deployment).
  </description>
  <acceptance_criteria>
    - [ ] Test results summarized (all three scenarios documented)
    - [ ] All three scenarios show PASS status
    - [ ] No failures or unexpected behaviors
    - [ ] Ready to proceed to Plan 1.3 (Stage 2 rules) and Plan 1.4 (staging deployment)
  </acceptance_criteria>
</task>

## Verification

1. Emulator running: `firebase emulator:start --only firestore` shows no errors
2. Rules loaded: No syntax errors in Firestore Emulator output
3. Three scenarios tested: User isolation, anonymous denial, subcollection inheritance
4. All tests passed: Expected behavior matched actual behavior

## Success Criteria

- [ ] Firestore Emulator running with Stage 1 rules deployed
- [ ] User isolation scenario tested and passed (authenticated user can read own, cannot read other's data)
- [ ] Anonymous denial scenario tested and passed (unauthenticated request denied)
- [ ] Subcollection inheritance scenario tested and passed (uid check applies to nested collections)
- [ ] All test results documented
- [ ] Stage 1 rules approved and ready for Stage 2 work

## Notes

**Emulator scope:** Testing in safe local environment. No real data affected. Can reset emulator between tests if needed: `firebase emulator:start --only firestore --clear-on-exit`

**Authentication in emulator:** Emulator accepts any valid JWT format. For testing, can use Firebase Admin SDK to generate valid tokens with specific UIDs.

**Next steps:** After Stage 1 validation, proceed to Plan 1.3 to write Stage 2 (exercises/custom exercises) rules, then deploy both stages to staging in Plan 1.4.

**Locked decisions:** Two-stage deployment ensures user isolation is rock-solid before adding shared collection complexity.
