---
phase: 01-firestore-security-hardening
plan: 06
type: execute
wave: 3
depends_on: ["01-05"]
files_modified:
  - firestore.rules
autonomous: false
must_haves:
  truths:
    - "Stage 1+2 rules deployed to production Firestore"
    - "Three critical scenarios validated in production without issues"
    - "User isolation enforced in production (real user data protected)"
    - "Anonymous access denied in production (all collections require auth)"
  artifacts:
    - path: "firestore.rules"
      provides: "Complete Stage 1+2 rules deployed to production"
      deployment_target: "Firebase production Firestore instance"
---

# Plan 1.6: Deploy Stage 1+2 Rules to Production & Validate

**Wave:** 3
**Depends on:** Plan 1.5 (staging validation & approval)
**Autonomous:** No (has manual validation checkpoint)

## Objective

Deploy the complete Stage 1+2 firestore.rules to production Firestore and validate the three critical security scenarios in the live environment to confirm user data is protected and anonymous access is denied.

**Purpose:** Roll out hardened Firestore rules to production after staging validation. Verify in live environment that security goals are achieved.

**Output:** Stage 1+2 rules live in production, validated, and stable.

## Execution Context

@/Users/lisagu/Projects/fitnessai-1/firestore.rules
@/Users/lisagu/Projects/fitnessai-1/.planning/phases/01-firestore-security-hardening/01-CONTEXT.md

## Context

**Deployment target:** Production Firestore database (live)

**Deployment method:** Firebase CLI `firebase deploy --only firestore:rules` targeting production project

**Pre-deployment requirement:** Plan 1.5 (staging) must be completed and approved. Staging validation proves rules are safe before production rollout.

**Rollback plan:** If production validation fails, can quickly revert to previous rules version via Firebase Console or CLI.

**Note:** Production has real user data. Testing must be done carefully without modifying user data. Focus on read-only validation where possible.

## Tasks

<task id="1.6.1" title="Deploy Stage 1+2 rules to production Firestore">
  <description>
  1. Ensure you have access to production Firestore project (configured in `.firebaserc` as default or named project)

  2. Run deployment command:
     ```
     firebase deploy --only firestore:rules --project fitnessai-prod
     ```
     (Replace `fitnessai-prod` with actual production project ID if different)

  3. Firebase CLI will:
     - Validate rule syntax
     - Deploy rules to production Firestore
     - Print deployment summary

  4. Verify deployment success: CLI output should show "Firestore rules deployed successfully" without errors

  **Important:** Review rules one more time before deploying. Ensure no typos or logic errors in firestore.rules (should have been validated in Plans 1.2 and 1.4, and in staging 1.5).

  If deployment fails, do NOT retry automatically. Investigate error and fix rules before retrying.
  </description>
  <acceptance_criteria>
    - [ ] Production project identified (fitnessai-prod or configured name)
    - [ ] Deployment command executed: `firebase deploy --only firestore:rules --project {prod-project-id}`
    - [ ] CLI output shows successful deployment
    - [ ] No deployment errors or warnings
    - [ ] Rules now live in production Firestore
  </acceptance_criteria>
</task>

<task id="1.6.2" title="Validate three critical scenarios in production (read-only testing)">
  <description>
  Validate the three critical security scenarios in production Firestore using EXISTING user data (do NOT modify or delete production data):

  **Key:** Use read-only tests only. Do NOT write to or modify production data.

  **Scenario 1: User Isolation (Your account cannot read other users' data)**
  - Use your account (logged in to production app)
  - Attempt to read another real user's workout data (if available in test environment)
  - Verify: You cannot access other users' data (permission denied)
  - Alternative: Use developer tools in app to test read access with direct path calls

  **Scenario 2: Anonymous Denied (Unauthenticated requests denied)**
  - In browser developer console or using curl, attempt to read production Firestore without authentication
  - Verify: Request denied with "Permission Denied" error
  - Command example:
    ```
    curl -X GET "https://firestore.googleapis.com/v1/projects/{project-id}/databases/(default)/documents/users/some-uid" \
      -H "Authorization: Bearer invalid-token"
    ```
  - Should fail with 403 Forbidden

  **Scenario 3: Subcollection Isolation (Nested paths inherit user isolation)**
  - Use your account to read your own workout subcollections
  - Verify: You can read your own nested data
  - Attempt to read another user's nested workout data
  - Verify: You cannot access other users' nested data (permission denied)

  **Approach:**
  - Use Firebase Console (Firestore tab) in production project
  - Use app itself (logged in as test user) to verify data access
  - Use curl with authentication tokens if programmatic testing needed

  **Important:** Do NOT modify, delete, or write to production data. Only test read access and permission enforcement.

  **Document results:** For each scenario, record expected vs. actual outcome.
  </description>
  <acceptance_criteria>
    - [ ] Scenario 1 tested: User isolation validated (you cannot read other users' data)
    - [ ] Scenario 2 tested: Anonymous denial validated (unauthenticated requests denied)
    - [ ] Scenario 3 tested: Subcollection isolation validated (nested paths protected)
    - [ ] All tests completed without modifying production data
    - [ ] Results documented
    - [ ] No unexpected permission errors or data access issues
  </acceptance_criteria>
</task>

<task id="1.6.3" title="Verify exercises auth requirement and custom exercises in production">
  <description>
  Validate Stage 2 functionality in production Firestore:

  **Scenario 4: Exercises Require Authentication (No anonymous access)**
  - Attempt to read /exercises collection without authentication (unauthenticated request)
  - Verify: Request denied with "Permission Denied"
  - Logged-in users should be able to read exercises (verify in app or with auth token)

  **Scenario 5: Custom Exercises User Isolation (User-scoped)**
  - Log in to production app as test user
  - Read your own custom exercises (if any) at /users/{your-uid}/exercises
  - Verify: You can read your own custom exercises
  - Attempt to read another user's custom exercises
  - Verify: You cannot access other users' custom exercises (permission denied)

  **Approach:**
  - Use Firebase Console or app to test read access
  - Unauthenticated tests: Use curl with no auth header or invalid token

  **Important:** Do NOT create, modify, or delete production custom exercises. Only test read access.

  **Document results:** For each scenario, record expected vs. actual outcome.
  </description>
  <acceptance_criteria>
    - [ ] Scenario 4 tested: Exercises require auth (anonymous denied, logged-in allowed)
    - [ ] Scenario 5 tested: Custom exercises are user-isolated (you can read own, not others')
    - [ ] All tests completed without modifying production data
    - [ ] Results documented
    - [ ] No unexpected permission errors
  </acceptance_criteria>
</task>

<task id="1.6.4" title="Checkpoint: Approve production deployment & record completion">
  <description>
  Review all test results from tasks 1.6.2 and 1.6.3:

  **Verification checklist:**
  - [ ] All five scenarios (3 Stage 1 + 2 Stage 2) validated in production
  - [ ] All tests show expected behavior (permission granted where allowed, denied where expected)
  - [ ] No unauthorized data access found
  - [ ] Firestore rules are stable and secure in production
  - [ ] No production data was modified during testing

  **Approval decision:**
  - If all criteria met: Approve production deployment, record completion
  - If issues found: Document issues, consider rollback to previous rules version, fix in firestore.rules, re-deploy to staging (Plan 1.5), re-test in production
  - If uncertain: Do NOT approve. Investigate further.

  **Upon approval:**
  1. Record in project notes: "Phase 1 Stage 1+2 rules deployed to production on {date}"
  2. Update STATE.md to reflect Phase 1 security foundation is complete
  3. Proceed to Plan 1.7 (TEST-CHECKLIST.md documentation)

  Type "approved" to proceed, or describe issues to investigate.
  </description>
  <acceptance_criteria>
    - [ ] All five scenarios tested in production
    - [ ] All tests show expected behavior
    - [ ] No data leakage or unauthorized access found
    - [ ] Production deployment approved
    - [ ] Completion recorded in project notes
  </acceptance_criteria>
</task>

## Verification

1. Deployment success: `firebase deploy --only firestore:rules` completed without errors to production
2. Production validation: All five scenarios tested in live Firestore
3. Expected behavior: All tests passed, no unauthorized access
4. Data integrity: No production data was modified during testing
5. Approval: User confirms production deployment is stable

## Success Criteria

- [ ] Stage 1+2 rules deployed to production Firestore
- [ ] All five critical scenarios tested and validated in production
- [ ] User isolation, anonymous denial, subcollection inheritance verified in production
- [ ] Exercises auth requirement verified in production
- [ ] Custom exercises user isolation verified in production
- [ ] Production deployment approved and stable
- [ ] Phase 1 security foundation complete

## Notes

**Locked decisions:**
- Two-stage deployment complete: Both Stage 1 (user isolation) and Stage 2 (exercises/custom exercises) live in production
- Three-stage validation done: Emulator (local) → Staging (cloud test) → Production (live)

**Rollback capability:** If issues arise after production deployment, can revert to previous rules version quickly via Firebase Console rule history or CLI rollback.

**Next step:** Plan 1.7 creates TEST-CHECKLIST.md with documented security scenarios for future audits and compliance verification.

**Production stability:** After this plan completes successfully, Firestore rules are hardened and production data is protected. No further Phase 1 work until TEST-CHECKLIST.md is created for documentation.

**Monitoring:** Consider monitoring Firestore permission denied errors in Cloud Logging to detect any unexpected access attempts (Phase 3 work, not Phase 1).
