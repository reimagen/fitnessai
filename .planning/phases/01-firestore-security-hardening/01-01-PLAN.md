---
phase: 01-firestore-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - firestore.rules
autonomous: true
must_haves:
  truths:
    - "Authenticated user can read only their own documents in users collection"
    - "Authenticated user can write only to their own UID paths"
    - "Unauthenticated requests to any collection return permission denied"
    - "Subcollections (workouts, profiles, PRs) inherit parent user isolation"
  artifacts:
    - path: "firestore.rules"
      provides: "User isolation and authentication rules for Stage 1 collections"
      rule_scope:
        - "users/{uid}"
        - "users/{uid}/profiles"
        - "users/{uid}/workouts"
        - "users/{uid}/personalRecords"
  key_links:
    - from: "firestore.rules"
      to: "Firestore collections"
      via: "isOwner() helper function validates request.auth.uid == path uid"
      pattern: "isOwner(userId) && request.auth.uid matches path"
---

# Plan 1.1: Audit Current Rules & Write Stage 1 User Isolation Rules

**Wave:** 1
**Depends on:** None
**Autonomous:** Yes

## Objective

Audit the current firestore.rules file for gaps in user isolation and authentication enforcement, then write comprehensive rules for Stage 1 collections (users, profiles, workouts, personalRecords) to enforce that users can only read/write their own data and prevent anonymous access.

**Purpose:** Establish the security foundation by ensuring user data is properly isolated and anonymous requests are rejected before proceeding to Stage 2 (exercises).

**Output:** Updated firestore.rules file with Stage 1 rules complete and ready for emulator testing.

## Execution Context

@/Users/lisagu/Projects/fitnessai-1/firestore.rules
@/Users/lisagu/Projects/fitnessai-1/.planning/phases/01-firestore-security-hardening/01-CONTEXT.md

## Context

**Current rules state:** Partially restricted. Some collections have basic rules (users isolation via isOwner), but need audit to confirm no gaps.

**Stage 1 scope:**
- `users/{uid}` — User account data (email, name, created timestamp)
- `users/{uid}/profiles` — User profile (age, weight, height, muscle mass)
- `users/{uid}/workouts` — Workout logs with exercise details
- `users/{uid}/personalRecords` — PR tracking

**Key requirement:** All Stage 1 collections require `request.auth != null` to prevent anonymous access.

**Audit focus:** Check for:
1. Explicit authentication requirement on all paths
2. User isolation enforced via uid matching
3. Subcollections inherit parent isolation
4. No overly permissive read/write rules (e.g., `allow read: if true`)

## Tasks

<task id="1.1.1" title="Audit current firestore.rules for Stage 1 gaps">
  <description>
  Read firestore.rules and verify that Stage 1 collections (users, profiles, workouts, personalRecords) have proper user isolation rules. Check for:

  1. All Stage 1 paths require `request.auth != null` (no anonymous access)
  2. User isolation enforced with `request.auth.uid == path uid` (e.g., `isOwner()` helper)
  3. Subcollections inherit parent isolation via path matching
  4. No rules allow global read/write (e.g., `allow read: if true` without uid check)
  5. Document the findings in a simple audit summary

  Expected findings: Current rules already have basic user isolation for users/{uid}, but may need explicit authentication checks added to ensure no anonymous access is possible.
  </description>
  <acceptance_criteria>
    - [ ] Read firestore.rules file
    - [ ] Audit checklist completed (5 items above)
    - [ ] Document gap findings (specific paths that need fixing)
    - [ ] Note any paths missing rules entirely
    - [ ] Ready to proceed with rule updates
  </acceptance_criteria>
</task>

<task id="1.1.2" title="Write comprehensive Stage 1 user isolation rules">
  <description>
  Update firestore.rules with complete Stage 1 rules:

  1. Keep isOwner() helper function for clarity
  2. For users/{uid}: Allow read, write if isOwner(uid)
  3. For users/{uid}/profiles: Allow read, write if isOwner(uid) from parent path
  4. For users/{uid}/workouts: Allow read, write if isOwner(uid) from parent path
  5. For users/{uid}/workouts/{workoutId}/sets: Inherit parent isolation (isOwner check on users/{uid})
  6. For users/{uid}/personalRecords: Allow read, write if isOwner(uid) from parent path
  7. Add explicit deny for any unauthenticated requests: `allow read, write: if request.auth == null`

  Key: All rules must check request.auth != null AND uid match. Use wildcard patterns for subcollections.

  Pattern for subcollections:
  ```
  match /users/{userId} {
    allow read, write: if isOwner(userId);
    match /profiles/{document=**} {
      allow read, write: if isOwner(userId);
    }
  }
  ```

  Do NOT add exercises, exerciseAliases, config, or customExercises rules yet (Stage 2).
  </description>
  <acceptance_criteria>
    - [ ] firestore.rules updated with Stage 1 rules
    - [ ] isOwner() helper function present and used consistently
    - [ ] All Stage 1 collections (users, profiles, workouts, PRs) have explicit rules
    - [ ] Subcollections use wildcard pattern to inherit parent isolation
    - [ ] No rules allow anonymous access (all require request.auth != null)
    - [ ] Syntax valid (no obvious Firestore rule syntax errors)
    - [ ] Stage 2 (exercises) rules NOT included yet
  </acceptance_criteria>
</task>

## Verification

1. Syntax validation: Review written rules for Firestore syntax correctness (no typos, valid function syntax, proper path matching)
2. Rule coverage: Confirm all Stage 1 paths have explicit rules with uid matching
3. Authentication requirement: Confirm all rules check `request.auth != null` before allowing access
4. Ready for emulator testing: No syntax errors; rules compile and can be deployed to emulator in Plan 1.2

## Success Criteria

- [ ] firestore.rules contains complete Stage 1 rules
- [ ] All Stage 1 collections require authentication (no anonymous access possible)
- [ ] User isolation enforced via uid matching in all rules
- [ ] Subcollections properly inherit parent user isolation
- [ ] Rules file is syntactically valid and ready for testing
- [ ] Stage 2 (exercises) rules deferred to Plan 1.2 (next task)

## Notes

**Locked decisions:**
- Rules location: firestore.rules in git repo
- Stage 1 focuses on user-isolated collections only (exercises/custom deferred to Stage 2)
- No admin role claims needed; service account will bypass rules for admin operations
- Subcollections inherit isolation from parent uid in path (e.g., workouts/{id}/sets inherit from users/{uid})

**Testing:** Manual validation in emulator (Plan 1.3). Do NOT deploy to staging/production yet.

**Context:** 01-CONTEXT.md defines user-isolated collections, shared collection scope, custom exercises strategy, and admin access model.
