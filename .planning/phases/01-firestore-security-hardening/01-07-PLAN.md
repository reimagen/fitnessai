---
phase: 01-firestore-security-hardening
plan: 07
type: execute
wave: 3
depends_on: ["01-06"]
files_modified:
  - TEST-CHECKLIST.md
autonomous: true
must_haves:
  truths:
    - "TEST-CHECKLIST.md documents three critical security scenarios"
    - "Each scenario has step-by-step validation instructions"
    - "Checklist can be used for audits and compliance verification"
    - "Test procedures are clear enough for manual validation by any team member"
  artifacts:
    - path: "TEST-CHECKLIST.md"
      provides: "Documented security scenarios and manual test procedures for Phase 1"
      location: ".planning/phases/01-firestore-security-hardening/"
      min_sections: 5
  key_links:
    - from: "TEST-CHECKLIST.md"
      to: "firestore.rules"
      via: "documents validation steps for rules enforcement"
      pattern: "Scenario → test steps → expected behavior → acceptance criteria"
---

# Plan 1.7: Create TEST-CHECKLIST.md for Phase 1 Security Validation

**Wave:** 3
**Depends on:** Plan 1.6 (production deployment complete)
**Autonomous:** Yes

## Objective

Create a comprehensive TEST-CHECKLIST.md document that records the three critical security scenarios (user isolation, anonymous denial, admin access) with step-by-step validation procedures. This checklist serves as the reference for future audits, compliance verification, and onboarding documentation.

**Purpose:** Ensure security validation is repeatable, documented, and auditable. Enable any team member to verify security compliance using a clear checklist.

**Output:** TEST-CHECKLIST.md file with detailed procedures for validating Phase 1 security requirements.

## Execution Context

@/Users/lisagu/Projects/fitnessai-1/firestore.rules
@/Users/lisagu/Projects/fitnessai-1/.planning/phases/01-firestore-security-hardening/01-CONTEXT.md

## Context

**Why this matters:** Firestore rules are the core security layer. Having documented, repeatable test procedures ensures:
1. Future developers can verify rules work as intended
2. Security audits have a reference checklist
3. Compliance reviews can point to documented validation
4. Onboarding new team members is easier (clear procedures)

**Three critical scenarios (from 01-CONTEXT.md):**
1. User isolation — Alice cannot read Bob's workouts
2. Anonymous denied — Unauthenticated request to any collection rejected
3. Admin access — Service account can write exercises; regular users cannot modify global exercises

**Test environment:** This checklist should be executable in both emulator (local) and production (live) environments. Include environment-specific notes where needed.

**Audience:** Security team, auditors, developers doing security verification.

## Tasks

<task id="1.7.1" title="Write TEST-CHECKLIST.md with three critical scenarios">
  <description>
  Create `.planning/phases/01-firestore-security-hardening/TEST-CHECKLIST.md` with the following structure:

  **1. Header & Overview**
  - Title: "Phase 1: Firestore Security Hardening — Test Checklist"
  - Date created
  - Purpose: Document and validate Phase 1 security requirements (SEC-01, SEC-02, SEC-06, SEC-07)
  - Audience: Security team, auditors, developers

  **2. Requirements Coverage**
  - Table mapping scenarios to requirements:
    | Scenario | Requirement | Purpose |
    | User Isolation | SEC-01 | Users can only read/write own data |
    | Anonymous Denied | SEC-02 | No anonymous access to any collection |
    | Exercise Admin | SEC-06 | Exercise writes restricted to admin-only |
    | User Profile Isolation | SEC-07 | User profile data scoped to own data |

  **3. Scenario 1: User Isolation (SEC-01)**

  **Test Objective:** Verify authenticated users can read only their own documents and cannot access other users' data.

  **Setup:**
  - Two test user accounts: Alice (alice@test.com), Bob (bob@test.com)
  - Alice has workout data at /users/{alice-uid}/workouts/{workout-id}
  - Both users logged in, tokens available

  **Test Steps:**
  1. Alice logs in, obtains auth token
  2. Alice reads /users/{alice-uid}/workouts/{workout-id}
  3. Expected: Success (200), Alice sees her own workout data
  4. Bob logs in, obtains auth token
  5. Bob attempts to read /users/{alice-uid}/workouts/{workout-id}
  6. Expected: Permission Denied (403), Bob cannot see Alice's data
  7. Alice attempts to read /users/{bob-uid}/workouts/{bob-workout-id}
  8. Expected: Permission Denied (403), Alice cannot see Bob's data

  **Test Tools:**
  - Firebase Console (Firestore tab)
  - Firebase SDK (web/node): `db.collection('users').doc(uid).collection('workouts').get()`
  - curl with auth tokens

  **Acceptance Criteria:**
  - [ ] Alice can read her own workouts
  - [ ] Bob cannot read Alice's workouts (403 Forbidden)
  - [ ] Alice cannot read Bob's workouts (403 Forbidden)
  - [ ] Subcollections inherit isolation: Alice can read /users/{alice-uid}/workouts/{id}/sets, Bob cannot

  **Environment:** Can be tested in Firestore Emulator (local) or Production. Use emulator for CI/CD, production for compliance audits.

  **Severity:** CRITICAL — User data leakage is a major security breach.

  **4. Scenario 2: Anonymous Denied (SEC-02)**

  **Test Objective:** Verify unauthenticated requests to any collection are denied.

  **Setup:**
  - Access to unauthenticated HTTP client (curl, Postman, browser)
  - Production or staging Firestore endpoint
  - No auth token

  **Test Steps:**
  1. Prepare unauthenticated request (no Authorization header)
  2. Attempt to read any collection: /users/{uid}, /exercises, /config, etc.
     ```
     curl -X GET "https://firestore.googleapis.com/v1/projects/{project-id}/databases/(default)/documents/users/any-uid"
     ```
  3. Expected: Permission Denied (403) or Unauthorized (401)
  4. Verify error message indicates authentication required, not "document not found"
  5. Repeat with another collection (/exercises) to confirm all require auth
  6. Attempt to create a new document without auth
  7. Expected: Permission Denied (403)

  **Test Tools:**
  - curl with -H flag to omit Authorization header
  - Postman (remove auth header)
  - Browser developer console (XHR without auth)

  **Acceptance Criteria:**
  - [ ] Unauthenticated read to /users denied (403/401)
  - [ ] Unauthenticated read to /exercises denied (403/401)
  - [ ] Unauthenticated read to /config denied (403/401)
  - [ ] Unauthenticated write to any collection denied (403/401)
  - [ ] Error indicates "Permission Denied", not "Not Found" (confirms auth check, not data absence)

  **Environment:** Can be tested against any Firestore database (emulator or production). Use production for compliance verification.

  **Severity:** CRITICAL — Anonymous access allows data scraping.

  **5. Scenario 3: Exercise Admin Access (SEC-06)**

  **Test Objective:** Verify that regular users cannot write to global exercises collection, but admin (service account) can.

  **Setup:**
  - Regular user account (authenticated, non-admin)
  - Admin access (Firebase Console or service account credentials)
  - Global exercises collection at /exercises

  **Test Steps (Regular User):**
  1. Regular user logs in, obtains auth token
  2. Regular user attempts to write to /exercises/{new-exercise-id}
  3. Expected: Permission Denied (403), user cannot create/update exercises
  4. Regular user attempts to update existing exercise
  5. Expected: Permission Denied (403)
  6. Regular user attempts to delete exercise
  7. Expected: Permission Denied (403)
  8. Regular user READS exercises (should work)
  9. Expected: Success (200), user can read global exercises

  **Test Steps (Admin):**
  1. Access Firebase Admin SDK or Firebase Console (authenticated as owner)
  2. Create/update exercise in /exercises collection via admin SDK
  3. Expected: Success (200), admin can modify exercises
  4. Verify exercise appears in global collection
  5. Verify regular user can read the newly created exercise

  **Test Tools:**
  - Firebase Console (Firestore tab): Direct edits to exercises collection (admin only)
  - Firebase Admin SDK: Using service account credentials
  - Regular user SDK: Attempting writes (should fail)

  **Acceptance Criteria:**
  - [ ] Regular user cannot create exercises (403 Forbidden)
  - [ ] Regular user cannot update exercises (403 Forbidden)
  - [ ] Regular user cannot delete exercises (403 Forbidden)
  - [ ] Regular user CAN READ exercises (200 Success)
  - [ ] Admin/service account CAN write exercises (200 Success)
  - [ ] Admin writes to exercises are visible to regular users immediately

  **Environment:** Emulator or production. Emulator recommended for frequent testing.

  **Severity:** HIGH — Unauthorized exercise creation/modification corrupts global data.

  **6. Supporting Scenario: User Profile Isolation (SEC-07)**

  **Test Objective:** Verify user profile data (age, weight, height) is scoped to own user.

  **Setup:**
  - Alice's profile at /users/{alice-uid}/profiles/{profile-id}
  - Alice and Bob authenticated

  **Test Steps:**
  1. Alice reads her own profile: Expected Success (200)
  2. Bob attempts to read Alice's profile: Expected Permission Denied (403)
  3. Alice updates her weight field: Expected Success (200)
  4. Bob attempts to update Alice's weight: Expected Permission Denied (403)

  **Acceptance Criteria:**
  - [ ] User can read own profile
  - [ ] User can update own profile
  - [ ] Other users cannot read user's profile (403)
  - [ ] Other users cannot update user's profile (403)

  **Severity:** HIGH — Profile data contains health info (weight, goals); privacy violation if exposed.

  **7. Testing Checklist**

  Use this checklist for each test run:

  - [ ] Environment identified (Emulator/Production/Staging)
  - [ ] Test accounts prepared (Alice, Bob, admin)
  - [ ] Firestore rules deployed to target environment
  - [ ] Scenario 1 (User Isolation): All criteria passed
  - [ ] Scenario 2 (Anonymous Denied): All criteria passed
  - [ ] Scenario 3 (Exercise Admin): All criteria passed
  - [ ] Scenario 4 (User Profile Isolation): All criteria passed
  - [ ] Test results documented
  - [ ] Date and tester name recorded
  - [ ] Any issues or unexpected behaviors noted
  - [ ] Sign-off: Approved or Issues Found

  **8. Frequency & Maintenance**

  - **When to run:** After rule changes, before major releases, during security audits, during onboarding
  - **Who runs:** Security team, QA engineers, developers verifying changes
  - **How often:** Minimum quarterly; more frequently if rules are modified
  - **Maintenance:** Update checklist if rules or collection structure changes

  **9. Notes & Known Limitations**

  - Service account bypass: Admin SDK bypasses Firestore rules. This is expected and required for admin operations (migrations, bulk updates).
  - Emulator vs. Production: Emulator tests locally with fake auth. Production tests real Firestore with real auth. Both are valuable.
  - Performance not tested: Checklist validates security only, not performance or rate limits.

  **10. Related Documentation**

  - Firestore rules: `/Users/lisagu/Projects/fitnessai-1/firestore.rules`
  - Phase context: `01-CONTEXT.md`
  - Phase plans: `01-01-PLAN.md` through `01-07-PLAN.md`
  - Requirements: `.planning/REQUIREMENTS.md` (SEC-01, SEC-02, SEC-06, SEC-07)
  </description>
  <acceptance_criteria>
    - [ ] TEST-CHECKLIST.md created at `.planning/phases/01-firestore-security-hardening/TEST-CHECKLIST.md`
    - [ ] Header with title, purpose, audience
    - [ ] Requirements coverage table (4 requirements mapped to scenarios)
    - [ ] Scenario 1 (User Isolation) fully documented with test steps, tools, acceptance criteria
    - [ ] Scenario 2 (Anonymous Denied) fully documented
    - [ ] Scenario 3 (Exercise Admin) fully documented
    - [ ] Scenario 4 (User Profile Isolation) fully documented
    - [ ] Testing checklist provided (reusable for future audits)
    - [ ] Frequency and maintenance guidance included
    - [ ] Related documentation references included
    - [ ] File is well-formatted and readable
  </acceptance_criteria>
</task>

<task id="1.7.2" title="Review checklist for clarity and completeness">
  <description>
  Review TEST-CHECKLIST.md for:

  1. **Clarity:** Can a new team member understand and execute each scenario without asking questions?
  2. **Completeness:** Are test steps clear? Are tools mentioned? Are expected outcomes specified?
  3. **Actionability:** Can scenarios be executed step-by-step as written?
  4. **Coverage:** Do the four scenarios cover all Phase 1 requirements (SEC-01, SEC-02, SEC-06, SEC-07)?
  5. **Maintainability:** Is the format structured for future updates/additions?

  If any gaps found, add clarification or missing sections.

  Example improvements:
  - Add specific curl command examples if missing
  - Clarify "Permission Denied" error codes (403 vs. 401)
  - Add environment setup instructions if unclear
  - Add troubleshooting section if common issues identified

  Approval signal: "Checklist is clear and complete, ready for use in audits."
  </description>
  <acceptance_criteria>
    - [ ] Checklist reviewed for clarity
    - [ ] Test steps are actionable and specific
    - [ ] Tools and expected outcomes are documented
    - [ ] All four scenarios are complete
    - [ ] Format is maintainable for future updates
    - [ ] No ambiguous or vague instructions
    - [ ] Approval: "Checklist is clear and complete"
  </acceptance_criteria>
</task>

## Verification

1. TEST-CHECKLIST.md file exists and is readable
2. Four security scenarios fully documented with test procedures
3. Each scenario has clear acceptance criteria
4. Checklist is actionable (can be executed step-by-step)
5. Related documentation references included

## Success Criteria

- [ ] TEST-CHECKLIST.md created and documented
- [ ] Four critical security scenarios fully covered (User Isolation, Anonymous Denial, Exercise Admin, User Profile Isolation)
- [ ] Test procedures are step-by-step and specific
- [ ] Acceptance criteria are clear and measurable
- [ ] Checklist is suitable for audits, compliance verification, and onboarding
- [ ] File is well-organized and maintainable

## Notes

**Purpose:** TEST-CHECKLIST.md is the reference document for security validation. It serves multiple audiences:
- **Security auditors:** Can use checklist to verify compliance
- **Developers:** Can follow steps to validate rules work correctly
- **Onboarding:** New team members can learn security validation procedures
- **CI/CD:** Future automation can reference test steps (Phase 7 CI/CD)

**Locked decisions:** Three critical scenarios documented (from 01-CONTEXT.md). Four supporting scenarios added for completeness (user profile isolation).

**Next step:** Phase 1 complete after this plan. STATE.md should be updated to reflect Phase 1 security foundation is live. Phase 2 (Server Action Input Validation) can now proceed independently.

**Usage:** Run TEST-CHECKLIST.md:
- After any Firestore rule changes
- Before major releases
- During security audits
- Quarterly as minimum maintenance
- During onboarding of new team members

**Maintenance:** Keep checklist updated if Firestore collections or rules change. Update dated example outputs if needed.
